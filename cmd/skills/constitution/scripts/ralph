#!/bin/bash
# Run a ralph loop on a fiber
# Usage: ralph <fiber-id> [--backend claude|codex] [-- extra-flags...]
#
# Supports both Claude Code and Codex backends.
# Default: claude. Set RALPH_BACKEND=codex or pass --backend codex.

set -e

FIBER_ID="${1:?Usage: ralph <fiber-id> [--backend claude|codex] [-- extra-flags...]}"
shift

BACKEND="${RALPH_BACKEND:-claude}"
if [[ "$1" == "--backend" ]]; then
    BACKEND="$2"
    shift 2
fi

EXTRA_FLAGS=""
if [[ "$1" == "--" ]]; then
    shift
    EXTRA_FLAGS="$*"
fi

FELT="$HOME/go/bin/felt"
SESSION="ralph-$FIBER_ID"
WORK_DIR="$(pwd)"

# Find fiber: project .felt/ first, then ~/loom
FELT_DIR=""
if "$FELT" show "$FIBER_ID" >/dev/null 2>&1; then
    FELT_DIR="$WORK_DIR"
elif (cd "$HOME/loom" && "$FELT" show "$FIBER_ID" >/dev/null 2>&1); then
    FELT_DIR="$HOME/loom"
else
    echo "Fiber not found: $FIBER_ID"
    exit 1
fi

# Check fiber has open/active status
if ! (cd "$FELT_DIR" && $FELT show "$FIBER_ID" 2>/dev/null | grep -qiE 'status:.*(open|active)'); then
    echo "Fiber $FIBER_ID must have status open or active to loop."
    echo "  Fix: felt edit $FIBER_ID -s open"
    exit 1
fi

# Check if already running
if tmux has-session -t "$SESSION" 2>/dev/null; then
    echo "Ralph already running: $SESSION"
    echo "  Attach: tmux attach -t $SESSION"
    exit 0
fi

# Write loop script to temp file (avoids heredoc quoting hell)
LOOP_SCRIPT=$(mktemp /tmp/ralph-loop-XXXXXX.sh)
cat > "$LOOP_SCRIPT" << 'LOOP'
#!/bin/bash
FIBER_ID="$1"
FELT_DIR="$2"
WORK_DIR="$3"
BACKEND="$4"
EXTRA_FLAGS="$5"
FELT="$HOME/go/bin/felt"

iteration=0

while (cd "$FELT_DIR" && $FELT show "$FIBER_ID" 2>/dev/null | grep -qiE 'status:.*(open|active)'); do
    cd "$WORK_DIR"
    iteration=$((iteration + 1))
    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "Ralph iteration $iteration — $(date '+%H:%M:%S')"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    FIBER_CONTENT=$(cd "$FELT_DIR" && $FELT show "$FIBER_ID")

    SYSPROMPT_FILE=$(mktemp /tmp/ralph-sys-XXXXXX.txt)
    PROMPT_FILE=$(mktemp /tmp/ralph-prompt-XXXXXX.txt)

    cat > "$SYSPROMPT_FILE" << SYSEOF
Ralph iteration $iteration. Fiber ID: $FIBER_ID

$FIBER_CONTENT
SYSEOF

    cat > "$PROMPT_FILE" << 'PROMPTEOF'
You are inside a ralph loop. Activate the ralph skill (/ralph) and follow its instructions for iterating on the constitution above.
PROMPTEOF

    PROMPT=$(cat "$PROMPT_FILE")

    if [[ "$BACKEND" == "codex" ]]; then
        codex --dangerously-bypass-approvals-and-sandbox \
            --config "developer_instructions=$(cat "$SYSPROMPT_FILE")" \
            $EXTRA_FLAGS \
            "$PROMPT"
    else
        claude --dangerously-skip-permissions \
            $EXTRA_FLAGS \
            --append-system-prompt "$(cat "$SYSPROMPT_FILE")" \
            <<< "$PROMPT"
    fi

    rm -f "$SYSPROMPT_FILE" "$PROMPT_FILE"

    echo "--- Iteration complete ---"
    sleep 2
done

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Ralph complete — $iteration iterations"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "Session kept open for inspection. Type exit to close."
exec bash -l
LOOP

chmod +x "$LOOP_SCRIPT"

echo "Starting ralph on $FIBER_ID"
echo "  Work dir: $WORK_DIR"
echo "  Fiber in: $FELT_DIR"
[[ -n "$EXTRA_FLAGS" ]] && echo "  Flags:    $EXTRA_FLAGS"

# Launch tmux with a login shell running the loop script
tmux new-session -d -s "$SESSION" -c "$WORK_DIR" \
    bash -l "$LOOP_SCRIPT" "$FIBER_ID" "$FELT_DIR" "$WORK_DIR" "$BACKEND" "$EXTRA_FLAGS"

echo "  Session:  $SESSION"
echo "  Attach:   tmux attach -t $SESSION"
